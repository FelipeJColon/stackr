---
title: "Intro to model averaging by interval score"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rstan)

```

## Theoretical explanation
The interval score is a proper scoring rule that scores a quantile forecast
against a true observed value. The interval score for a single forecast is 
computed as 

$$score = (upper - lower) + 2/\alpha \cdot (lower - true\_value) \cdot 
        \mathbb{1}(true_values < lower) + 2/\alpha \cdot (true\_value - upper) \cdot 
        \mathbb{1}(true\_value > upper)$$

where $\alpha$ equals 1 minus the range covered bei the prediction interval
(e.g. $\alpha = 0.1$ for the 90 \% prediction interval) and $\mathbb{1}()$ is
the indicator function. 

A weighted average of quantiles provided by different models is optimized in 
Stan. The model takes the following inputs: 
  - K, integer, number of models
  - T, integer, number of time points to score
  - alpha, real, alpha value;
  - an array of size two filled with two TxK matrices that hold the lower 
  (and upper, respectively) prediction quantile for all time points from all 
  models. The necessary R dimensions are dim = c(2, T, K)
  - y, vector of observed values
  - lambda, vector with weights for different time points
  - dirichlet_alpha, real, prior for the weights. Try 1.01

## Example


```{r example}
m <- rstan::stan_model("../stan/model_average_quantiles.stan")

T = 100
y_true <- rnorm(T)

predictions_upper <- cbind(rnorm(T, 0.5),
                           rnorm(T, 0.1),
                           rnorm(T, 0.9))
predictions_lower <- cbind(rnorm(T, - 0.5),
                           rnorm(T, - 0.1),
                           rnorm(T, - 0.9))


pred <- array(c(predictions_lower, predictions_upper), c(2, T, 3))
lambda <- rep(1, T)


standata <- list(y = y_true,
                 K = 3,
                 T = T,
                 alpha = 0.5,
                 forecasts = pred,
                 lambda = lambda,
                 dirichlet_alpha = 1.01)

opt <- rstan::optimizing(m, data = standata)
opt_sampl <- rstan::sampling(m, data = standata)

opt
opt_sampl


```


